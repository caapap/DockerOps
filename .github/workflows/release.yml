name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Install dependencies
      run: go mod tidy
      
    - name: Build for multiple platforms
      run: |
        mkdir -p build
        
        # è®¾ç½®æ„å»ºæ ‡å¿—
        LDFLAGS="-s -w -X dockerops/cmd.VERSION=${{ steps.get_version.outputs.VERSION }}"
        
        # æ„å»ºå„å¹³å°ç‰ˆæœ¬
        echo "æ„å»º Windows amd64..."
        GOOS=windows GOARCH=amd64 go build -ldflags="$LDFLAGS" -o build/DockerOps-${{ steps.get_version.outputs.VERSION }}-windows-amd64.exe main.go
        
        echo "æ„å»º Linux amd64..."
        GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o build/DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-amd64 main.go
        
        echo "æ„å»º Linux arm64..."
        GOOS=linux GOARCH=arm64 go build -ldflags="$LDFLAGS" -o build/DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-arm64 main.go
        
        echo "æ„å»º macOS arm64..."
        GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o build/DockerOps-${{ steps.get_version.outputs.VERSION }}-darwin-arm64 main.go
        
    - name: Create release packages
      run: |
        cd build
        
        # ä¸ºWindowsç‰ˆæœ¬åˆ›å»ºzipåŒ…
        zip DockerOps-${{ steps.get_version.outputs.VERSION }}-windows-amd64.zip DockerOps-${{ steps.get_version.outputs.VERSION }}-windows-amd64.exe ../README.md
        
        # ä¸ºUnixç‰ˆæœ¬åˆ›å»ºtar.gzåŒ…
        tar -czf DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-amd64 ../README.md
        tar -czf DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-arm64 ../README.md
        tar -czf DockerOps-${{ steps.get_version.outputs.VERSION }}-darwin-arm64.tar.gz DockerOps-${{ steps.get_version.outputs.VERSION }}-darwin-arm64 ../README.md
        
        # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
        ls -la
        
    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## DockerOps ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### æ–°åŠŸèƒ½" >> $GITHUB_OUTPUT
        echo "- ğŸš€ å¢å¼ºç‰ˆDockeré•œåƒæ‹‰å–å·¥å…·" >> $GITHUB_OUTPUT
        echo "- ğŸ” å¤šé•œåƒä»“åº“æœç´¢å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»" >> $GITHUB_OUTPUT
        echo "- âš™ï¸ é…ç½®æ–‡ä»¶ç®¡ç†é•œåƒä»“åº“" >> $GITHUB_OUTPUT
        echo "- ğŸ·ï¸ æ ‡ç­¾è½¬æ¢è§„åˆ™æ”¯æŒ" >> $GITHUB_OUTPUT
        echo "- ğŸŒ è·¨å¹³å°æ”¯æŒ (Windows, Linux, macOS)" >> $GITHUB_OUTPUT
        echo "- ğŸ“Š è¿›åº¦æ¡æ˜¾ç¤ºå’Œå¹¶å‘ä¸‹è½½" >> $GITHUB_OUTPUT
        echo "- ğŸ“¦ Dockeré•œåƒæ¨é€ã€åŠ è½½ã€ä¿å­˜ç­‰æ“ä½œ" >> $GITHUB_OUTPUT
        echo "- ğŸ‡¨ğŸ‡³ ä¼˜å…ˆä½¿ç”¨å›½å†…é•œåƒæºï¼Œè‡ªåŠ¨é€‰æ‹©æœ€å¿«æº" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### æ”¯æŒçš„å‘½ä»¤" >> $GITHUB_OUTPUT
        echo "- \`pull\` - æ‹‰å–Dockeré•œåƒ" >> $GITHUB_OUTPUT
        echo "- \`push\` - æ¨é€é•œåƒåˆ°ä»“åº“" >> $GITHUB_OUTPUT
        echo "- \`load\` - ä»æœ¬åœ°taræ–‡ä»¶åŠ è½½é•œåƒ" >> $GITHUB_OUTPUT
        echo "- \`save\` - ä¿å­˜é•œåƒåˆ°æœ¬åœ°taræ–‡ä»¶" >> $GITHUB_OUTPUT
        echo "- \`save-compose\` - ä¿å­˜docker-compose.ymlä¸­çš„é•œåƒ" >> $GITHUB_OUTPUT
        echo "- \`match\` - åŒ¹é…æŒ‡å®šå‰ç¼€çš„é•œåƒ" >> $GITHUB_OUTPUT
        echo "- \`list\` - åˆ—å‡ºé…ç½®çš„é•œåƒä»“åº“" >> $GITHUB_OUTPUT
        echo "- \`config show\` - æ˜¾ç¤ºå½“å‰é…ç½®" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ä¸‹è½½è¯´æ˜" >> $GITHUB_OUTPUT
        echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š" >> $GITHUB_OUTPUT
        echo "- **Windows**: DockerOps-${{ steps.get_version.outputs.VERSION }}-windows-amd64.zip" >> $GITHUB_OUTPUT
        echo "- **Linux**: DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz" >> $GITHUB_OUTPUT
        echo "- **macOS**: DockerOps-${{ steps.get_version.outputs.VERSION }}-darwin-arm64.tar.gz (Apple Silicon)" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ä½¿ç”¨æ–¹æ³•" >> $GITHUB_OUTPUT
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…" >> $GITHUB_OUTPUT
        echo "2. è§£å‹åˆ°ä»»æ„ç›®å½•" >> $GITHUB_OUTPUT
        echo "3. è¿è¡Œ \`./DockerOps --help\` æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯" >> $GITHUB_OUTPUT
        echo "4. è¿è¡Œ \`./DockerOps pull nginx:latest\` å¼€å§‹æ‹‰å–é•œåƒ" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: DockerOps ${{ steps.get_version.outputs.VERSION }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        draft: false
        prerelease: false
        files: |
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-windows-amd64.zip
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-darwin-arm64.tar.gz
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-windows-amd64.exe
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-amd64
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-linux-arm64
          build/DockerOps-${{ steps.get_version.outputs.VERSION }}-darwin-arm64
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 